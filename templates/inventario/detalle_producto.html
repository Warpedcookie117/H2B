{% extends "partials/base.html" %}
{% load static %}

{% block title %}Detalle de {{ producto.nombre }}{% endblock %}

{% block content %}

<div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow space-y-10">

    <!-- ENCABEZADO -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
        <h2 class="text-3xl font-extrabold text-red-700">
            Detalle del producto
        </h2>

        <a href="javascript:history.back()"
        class="inline-flex items-center gap-2 text-red-700 font-semibold hover:text-red-900 transition">

            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 19l-7-7 7-7" />
            </svg>

            Regresar
        </a>
    </div>

    <!-- FOTO + CÓDIGO -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- FOTO -->
        <div class="border p-4 rounded-lg bg-gray-50 text-center shadow-sm">
            <h3 class="font-semibold mb-3 text-gray-700">Imagen del producto</h3>

            {% if producto.foto_url %}
                <img src="{{ producto.foto_url.url }}"
                     class="max-h-72 mx-auto rounded-lg shadow">
            {% else %}
                <p class="text-gray-500 italic">Sin imagen</p>
            {% endif %}
        </div>

        <!-- CÓDIGO -->
        <div class="border p-4 rounded-lg bg-gray-50 text-center shadow-sm">
            <h3 class="font-semibold mb-3 text-gray-700">Código del producto</h3>

            <img id="codigo-img"
                 class="mx-auto max-h-72 rounded"
                 src="">

            <p class="mt-3 text-gray-700 font-mono text-lg">{{ producto.codigo_barras }}</p>
            <p class="text-sm text-gray-500">Tipo: {{ producto.tipo_codigo }}</p>
        </div>

    </div>

    <!-- INFORMACIÓN GENERAL -->
    <div>
        <h3 class="text-xl font-bold text-gray-700 mb-4">Información del producto</h3>

        <form method="POST" enctype="multipart/form-data"
              class="grid grid-cols-1 md:grid-cols-2 gap-6 {% if not puede_editar %}pointer-events-none opacity-70{% endif %}">
            {% csrf_token %}

            <div>
                <label class="font-semibold">Nombre</label>
                <input type="text" name="nombre" value="{{ producto.nombre }}"
                       class="w-full border rounded p-2">
            </div>

            <div>
                <label class="font-semibold">Descripción</label>
                <textarea name="descripcion" class="w-full border rounded p-2">{{ producto.descripcion }}</textarea>
            </div>

            <div>
                <label class="font-semibold">Precio menudeo</label>
                <input type="number" step="0.01" name="precio_menudeo"
                       value="{{ producto.precio_menudeo }}"
                       class="w-full border rounded p-2">
            </div>

            <div>
                <label class="font-semibold">Precio mayoreo</label>
                <input type="number" step="0.01" name="precio_mayoreo"
                       value="{{ producto.precio_mayoreo }}"
                       class="w-full border rounded p-2">
            </div>

            <div>
                <label class="font-semibold">Precio docena</label>
                <input type="number" step="0.01" name="precio_docena"
                       value="{{ producto.precio_docena }}"
                       class="w-full border rounded p-2">
            </div>

            <div>
                <label class="font-semibold">Categoría padre</label>
                <input type="text" disabled value="{{ producto.categoria_padre.nombre }}"
                       class="w-full border rounded p-2 bg-gray-100">
            </div>

            <div>
                <label class="font-semibold">Subcategoría</label>
                <input type="text" disabled value="{{ producto.categoria.nombre }}"
                       class="w-full border rounded p-2 bg-gray-100">
            </div>

            <div>
                <label class="font-semibold">Dueño</label>
                <input type="text" disabled value="{{ producto.dueño }}"
                       class="w-full border rounded p-2 bg-gray-100">
            </div>

            <div>
                <label class="font-semibold">Registrado por</label>
                <input type="text" disabled value="{{ producto.registrado_por }}"
                       class="w-full border rounded p-2 bg-gray-100">
            </div>

            <div>
                <label class="font-semibold">Fecha de registro</label>
                <input type="text" disabled value="{{ producto.fecha_registro }}"
                       class="w-full border rounded p-2 bg-gray-100">
            </div>

            {% if puede_editar %}
            <div class="col-span-full">
                <button class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">
                    Guardar cambios
                </button>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- ATRIBUTOS DEL PRODUCTO -->
    <div>
        <h3 class="text-xl font-bold text-gray-700 mb-4">Atributos del producto</h3>

        {% if atributos %}
            <ul class="space-y-3">
                {% for a in atributos %}
                    <li class="border p-3 rounded bg-gray-50 flex justify-between items-center shadow-sm">
                        <span class="font-semibold">{{ a.nombre }}</span>

                        {% if puede_editar %}
                            <input type="text"
                                   name="attr_{{ a.nombre }}"
                                   value="{{ a.valor }}"
                                   class="border rounded p-1 w-40 text-sm">
                        {% else %}
                            <span class="text-gray-700">{{ a.valor|default:"(sin valor)" }}</span>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-gray-500">Esta subcategoría no tiene atributos configurados.</p>
        {% endif %}
    </div>

    <!-- TEMPORADAS -->
    <div>
        <h3 class="text-xl font-bold text-gray-700 mb-4">Temporadas</h3>

        {% if producto.temporada.all %}
            <ul class="space-y-2">
                {% for t in producto.temporada.all %}
                    <li class="border p-3 rounded bg-gray-50 shadow-sm">
                        {{ t.nombre }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-gray-500">Este producto no tiene temporada asignada.</p>
        {% endif %}
    </div>

    <!-- INVENTARIO POR UBICACIÓN -->
    <div>
        <h3 class="text-xl font-bold text-gray-700 mb-4">Inventario por ubicación</h3>

        {% if inventarios %}
            <ul class="space-y-2">
                {% for inv in inventarios %}
                    <li class="border p-3 rounded bg-gray-50 flex justify-between items-center shadow-sm">
                        <span>{{ inv.ubicacion.nombre }}</span>
                        <span class="font-bold text-red-700">{{ inv.cantidad_actual }}</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-gray-500">Este producto no tiene inventario registrado.</p>
        {% endif %}
    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const img = document.getElementById("codigo-img");
    const url = "{% url 'inventario:codigo_base64' producto.id %}";

    fetch(url)
        .then(res => res.json())
        .then(data => {
            if (data.imagen) {
                img.src = `data:image/png;base64,${data.imagen}`;
            }
        })
        .catch(err => console.error("Error cargando código:", err));
});
</script>
{% endblock %}