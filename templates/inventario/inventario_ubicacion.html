{% extends "partials/base.html" %}
{% load static %}

{% block title %}Inventario en {{ ubicacion.nombre }}{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto p-4">

    <!-- ENCABEZADO -->
    <div class="p-4 rounded-lg text-white mb-6 shadow"
         style="background: {{ color_header }};">
        <h2 class="text-2xl font-bold">Inventario en {{ ubicacion.nombre }}</h2>
    </div>

    {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
                <div class="px-4 py-3 rounded-lg shadow 
                            {% if message.tags == 'success' %} bg-green-100 border border-green-300 text-green-800 
                            {% elif message.tags == 'error' %} bg-red-100 border border-red-300 text-red-800 
                            {% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- MENSAJE GLOBAL -->
    <div id="mensajeGlobal" class="mb-4"></div>

    <!-- BOTONES -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">

        <button onclick="abrirModalTransferirMultiple({{ ubicacion.id }})"
                class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white px-5 py-2.5 rounded-lg font-semibold shadow-md flex items-center justify-center gap-2 transition transform hover:scale-105">
            <i class="fas fa-layer-group text-lg"></i>
            Transferencia m√∫ltiple
        </button>

        <a href="{% url 'inventario:nuevo_producto' %}"
           class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg text-lg tracking-wide flex items-center justify-center gap-2 transition transform hover:scale-105">
            <i class="fas fa-plus-circle text-xl"></i>
            Registrar nuevo producto
        </a>

    </div>

    <!-- BUSCADOR -->
    <div class="mb-6">
        <input 
            id="buscadorProductos"
            type="text"
            placeholder="Buscar producto por nombre, categor√≠a, subcategor√≠a o c√≥digo..."
            class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
        >
    </div>

    <!-- GRID RESPONSIVE -->
    <div id="gridProductos" class="
        grid 
        grid-cols-1 
        sm:grid-cols-2 
        md:grid-cols-3 
        lg:grid-cols-4 
        xl:grid-cols-5 
        gap-4">

        {% for inv in productos %}
        <div id="card_{{ inv.producto.id }}_{{ ubicacion.id }}"
            class="cardProducto producto-card rounded-lg shadow p-3 flex flex-col border hover:shadow-lg transition opacity-100 scale-100
                   {% if inv.cantidad_actual == 0 %}
                        bg-gray-100 border-gray-400
                   {% else %}
                        bg-white
                   {% endif %}
                   {% if request.GET.highlight == inv.producto.id|stringformat:"s" %}
                        {% if request.GET.new %}
                            highlight-green
                        {% else %}
                            highlight-yellow
                        {% endif %}
                    {% endif %}"

            data-producto="{{ inv.producto.id }}"
            data-ubicacion="{{ ubicacion.id }}"
            data-nombre="{{ inv.producto.nombre }}"
            data-cantidad="{{ inv.cantidad_actual }}">

            <!-- IMAGEN -->
            <div class="w-full h-28 sm:h-32 bg-gray-100 rounded flex items-center justify-center overflow-hidden mb-2">
                {% if inv.producto.foto_url %}
                    <img src="{{ inv.producto.foto_url.url }}" class="object-contain h-full w-full">
                {% else %}
                    <img src="{% static 'img/no-image.png' %}" class="object-contain h-full w-full">
                {% endif %}
            </div>

            <!-- NOMBRE -->
            <h3 class="nombre text-red-700 font-bold text-sm sm:text-base mb-1">{{ inv.producto.nombre }}</h3>

            <!-- CATEGOR√çAS -->
            <p class="categoria text-xs sm:text-sm text-gray-600">
                <span class="font-semibold">Categor√≠a:</span> {{ inv.producto.categoria_padre.nombre }}
            </p>

            <p class="subcategoria text-xs sm:text-sm text-gray-600 mb-1">
                <span class="font-semibold">Subcategor√≠a:</span> {{ inv.producto.categoria.nombre }}
            </p>

            <!-- CANTIDAD -->
            <p class="text-sm font-semibold mt-2">
                Cantidad: <span class="cantidad-ubicacion text-red-700 font-bold">{{ inv.cantidad_actual }}</span>
            </p>

            <!-- BOT√ìN ELIMINAR SI CANTIDAD = 0 -->
            {% if inv.cantidad_actual == 0 %}
            <button 
                onclick="eliminarInventarioHandler({{ inv.producto.id }}, {{ ubicacion.id }})"
                class="btn-eliminar-inv mt-2 text-red-600 text-xs sm:text-sm flex items-center gap-1 hover:text-red-800 font-semibold">
                üóëÔ∏è Eliminar inventario
            </button>
            {% endif %}

            <!-- ACCIONES PRINCIPALES -->
            <div class="mt-3 space-y-1">

                <button onclick="abrirModalAgregarDesdeCard({{ inv.producto.id }}, {{ ubicacion.id }})"
                        class="w-full bg-green-600 hover:bg-green-700 text-white py-1.5 rounded text-xs sm:text-sm font-semibold flex items-center justify-center gap-1">
                    <i class="fas fa-plus-circle"></i> Agregar
                </button>

                <button onclick="abrirModalAjustarDesdeCard({{ inv.producto.id }}, {{ ubicacion.id }})"
                        class="w-full bg-orange-500 hover:bg-orange-600 text-white py-1.5 rounded text-xs sm:text-sm font-semibold flex items-center justify-center gap-1">
                    <i class="fas fa-edit"></i> Ajustar
                </button>

                <button onclick="abrirModalTransferir({{ inv.producto.id }}, {{ ubicacion.id }})"
                        class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 py-1.5 rounded text-xs sm:text-sm font-semibold flex items-center justify-center gap-1">
                    <i class="fas fa-exchange-alt"></i> Transferir
                </button>

            </div>

            <!-- ACCIONES SECUNDARIAS -->
            <div class="mt-3 space-y-1">
                <button onclick="mostrarEtiquetaInterna(this)"
                        data-url="{% url 'inventario:codigo_base64' inv.producto.id %}"
                        data-id="{{ inv.producto.id }}"
                        data-ubicacion="{{ ubicacion.id }}"
                        class="w-full bg-gray-800 hover:bg-gray-900 text-white py-1.5 rounded text-xs sm:text-sm font-semibold flex items-center justify-center gap-1">
                    <i class="fas fa-barcode"></i> Ver etiqueta
                </button>

                <a href="{% url 'inventario:detalle_producto' inv.producto.id %}"
                   class="w-full bg-blue-600 hover:bg-blue-700 text-white py-1.5 rounded text-xs sm:text-sm font-semibold flex items-center justify-center gap-1">
                    <i class="fas fa-info-circle"></i> Ver detalle
                </a>
            </div>

            <!-- ETIQUETA INTERNA -->
            <div id="etiqueta-{{ inv.producto.id }}-{{ ubicacion.id }}"
                 class="max-h-0 overflow-hidden transition-all duration-300 mt-3 p-0 bg-gray-50 border rounded opacity-0">

                <img id="img-{{ inv.producto.id }}-{{ ubicacion.id }}" src="" class="w-full mb-2" />

                <div class="flex gap-2 justify-center mb-2">
                    <button onclick="imprimirEtiqueta({{ inv.producto.id }}, {{ ubicacion.id }})"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs whitespace-nowrap">
                        Imprimir
                    </button>

                    <button onclick="descargarEtiqueta({{ inv.producto.id }}, {{ ubicacion.id }})"
                            class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs whitespace-nowrap">
                        Descargar
                    </button>
                </div>

                <div id="codigo-{{ inv.producto.id }}-{{ ubicacion.id }}"
                     class="codigo text-[10px] bg-gray-200 p-2 rounded font-mono text-center select-all break-all cursor-pointer">
                    {{ inv.producto.codigo_barras }}
                </div>

            </div>

        </div>

        {% include "inventario/modales/modal_agregar.html" with inv=inv ubicacion=ubicacion %}
        {% include "inventario/modales/modal_ajustar.html" with inv=inv ubicacion=ubicacion %}

        {% empty %}
            <p class="text-gray-600 text-sm">No hay productos registrados en esta ubicaci√≥n.</p>
        {% endfor %}

    </div>

    <!-- MODALES UNIVERSALES -->
    {% include "inventario/modales/modal_transferir.html" %}
    {% include "inventario/modales/modal_transferir_multiple.html" %}
    {% include "inventario/modales/modal_eliminar.html" %}

</div>

{{ inventario_todas_json|json_script:"inventarioTodas" }}
<script>
    window.inventarioTodas = JSON.parse(document.getElementById("inventarioTodas").textContent);
</script>

{% endblock %}

{% block scripts %}
<script src="{% static 'js/inventario_ubicacion/utils.js' %}"></script>
<script src="{% static 'js/inventario_ubicacion/modales.js' %}"></script>
<script src="{% static 'js/inventario_ubicacion/agregar.js' %}"></script>
<script src="{% static 'js/inventario_ubicacion/ajustar.js' %}"></script>
<script src="{% static 'js/inventario_ubicacion/etiquetas.js' %}"></script>
<script src="{% static 'js/inventario_ubicacion/transferir.js' %}"></script>
<script src="{% static 'js/inventario_ubicacion/transferir_multiple.js' %}"></script>
<script src="{% static 'js/inventario_ubicacion/eliminar.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const highlighted = document.querySelector(".highlight-yellow, .highlight-green");
    if (highlighted) {
        highlighted.scrollIntoView({ behavior: "smooth", block: "center" });
    }
});
</script>

{% endblock %}