{% extends 'partials/base.html' %}
{% load static %}

{% block content %}

<style>
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}
@keyframes fadeOut {
  from { opacity: 1; transform: scale(1); }
  to { opacity: 0; transform: scale(0.95); }
}

.animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
.animate-fadeOut { animation: fadeOut 0.3s ease-in-out; }
</style>

<div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 border-b pb-2 gap-3">
  <h2 class="text-3xl font-bold text-gray-800">Inventario Global</h2>

  <div class="flex gap-3 w-full md:w-auto">
    <input type="text" id="buscadorProductos"
          placeholder="Buscar producto..."
          class="px-3 py-2 border rounded-lg shadow-sm focus:ring focus:ring-blue-300 w-full md:w-64">

    <a href="{% url 'inventario:nuevo_producto' %}"
       class="flex items-center gap-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition whitespace-nowrap">
      <i class="fa-solid fa-plus"></i> Nuevo producto
    </a>
  </div>
</div>

<!-- üî• KANBAN RESPONSIVE -->
<div class="flex flex-col md:flex-row gap-6 pb-6 w-full">

{% for u in ubicaciones %}
<div class="dropzone bg-gray-50 rounded-lg shadow-md p-4 flex-1 min-w-full md:min-w-[280px]" data-destino="{{ u.id }}">

  <h3 class="text-xl font-semibold text-gray-700 mb-4">
    üì¶ {{ u.nombre }}
  </h3>

  <div class="space-y-4">

    {% for producto in productos %}
      {% for inv in producto.inventarios.all %}
        {% if inv.ubicacion.id == u.id %}

        <div class="bg-white rounded-lg shadow p-4 producto-card transition-all duration-300"
             draggable="true"
             data-producto="{{ producto.id }}"
             data-origen="{{ inv.ubicacion.id }}"
             data-nombre="{{ producto.nombre|lower }}"
             data-descripcion="{{ producto.descripcion|lower }}"
             data-categoria="{% for cat in producto.categoria.all %}{{ cat.nombre }} {% endfor %}"
             data-temporada="{% for temp in producto.temporada.all %}{{ temp.nombre }} {% endfor %}">

          <div class="warning-msg hidden text-yellow-700 text-sm font-semibold mb-2"></div>

          <div class="mb-2">
            {% if producto.codigo_barras and producto.tipo_codigo %}
              <button onclick="mostrarEtiquetaInterna(this)"
                      data-url="{% url 'inventario:codigo_base64' producto.id %}"
                      data-id="{{ producto.id }}"
                      data-ubicacion="{{ inv.ubicacion.id }}"
                      class="text-blue-600 hover:underline text-sm">
                <i class="fa-solid fa-barcode mr-1"></i> Ver etiqueta
              </button>

              <div id="etiqueta-{{ producto.id }}-{{ inv.ubicacion.id }}"
                   class="etiqueta-container bg-gray-50 border border-gray-200 rounded
                          max-h-0 opacity-0 overflow-hidden transition-all duration-300 p-0 mt-2
                          text-center text-sm shadow-sm">

                <img id="img-{{ producto.id }}-{{ inv.ubicacion.id }}" class="h-20 mx-auto mb-2" />

                <div class="text-gray-700 font-mono tracking-widest">{{ producto.codigo_barras }}</div>
                <div class="text-xs text-gray-500 italic mt-1">Tipo: {{ producto.tipo_codigo|upper }}</div>

                <div class="flex justify-center gap-2 mt-3">
                  <button onclick="imprimirEtiqueta('{{ producto.id }}','{{ inv.ubicacion.id }}')"
                          class="text-xs text-white bg-blue-600 px-2 py-1 rounded">üñ®Ô∏è Imprimir</button>

                  <button onclick="descargarEtiqueta('{{ producto.id }}','{{ inv.ubicacion.id }}')"
                          class="text-xs text-white bg-green-600 px-2 py-1 rounded">‚¨áÔ∏è Descargar</button>
                </div>
              </div>
            {% else %}
              <span class="text-gray-400 italic text-sm">Sin c√≥digo</span>
            {% endif %}
          </div>

          <h4 class="text-lg font-bold text-gray-800">{{ producto.nombre }}</h4>
          <p class="text-sm text-gray-600">{{ producto.descripcion }}</p>

          <ul class="mt-3 text-sm text-gray-700 space-y-1">
            <li>‚Ä¢ Menudeo: ${{ producto.precio_menudeo }}</li>
            <li>‚Ä¢ Mayoreo: ${{ producto.precio_mayoreo }}</li>
            <li>‚Ä¢ Docena: ${{ producto.precio_docena }}</li>
            <li class="cantidad-label">‚Ä¢ Cantidad: {{ inv.cantidad_actual }}</li>

            <li>‚Ä¢ Temporada:
              {% for temp in producto.temporada.all %}
                {{ temp.nombre }}
              {% empty %}
                Sin temporada
              {% endfor %}
            </li>
          </ul>

          <div class="flex gap-2 mt-3">
            <a href="{% url 'inventario:productos_por_ubicacion' inv.ubicacion.id %}?highlight={{ producto.id }}"
              class="inline-block bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700 whitespace-nowrap">
              üìç Ver en ubicaci√≥n
            </a>
          </div>

        </div>

        {% endif %}
      {% endfor %}
    {% empty %}
      <p class="text-gray-500 italic">No hay productos en {{ u.nombre }}.</p>
    {% endfor %}

  </div>
</div>
{% endfor %}

</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'js/inventario_ubicacion/etiquetas.js' %}"></script>
<script src="{% static 'js/lista_productos.js' %}"></script>
{% endblock %}